---

copyright:
years: 2020
lastupdated: "2020-03-30"

---

{:new_window: target="blank"}
{:shortdesc: .shortdesc}
{:screen: .screen}
{:codeblock: .codeblock}
{:pre: .pre}
{:child: .link .ulchildlink}
{:childlinks: .ullinks}

# ロールバックによるエッジ・サービスの更新
{: #service_rollback}

エッジ・ノードのサービスは通常、重要な機能を実行します。そのため、エッジ・サービスの新しいバージョンを多くのエッジ・ノードにロールアウトする際には、デプロイメントが成功したかをモニターし、いずれかのエッジ・ノードで失敗した場合には、前のエッジ・サービス・バージョンにノードを戻すことが大切です。 {{site.data.keyword.edge_notm}} ({{site.data.keyword.ieam}}) は、これを自動的に実行可能です。 パターンまたはデプロイメント・ポリシーで、新しいサービス・バージョンが失敗した場合に、前のどのサービス・バージョンを使用するかを定義することができます。

以下の内容では、既存エッジ・サービスの新しいバージョンをロールアウトする方法のさらなる詳細と、パターンまたはデプロイメント・ポリシーでロールバック設定を更新するためのソフトウェア開発におけるベスト・プラクティスを示します。

## 新規エッジ・サービス定義の作成
{: #creating_edge_service_definition}

[デバイス用のエッジ・サービスの開発](../OH/docs/developing/developing.md)と[開発の詳細](../developing/developing_details.md)のセクションに説明されているように、エッジ・サービスの新しいバージョンをリリースするための主なステップは以下のとおりです。

- 新しいバージョンに求められるように、エッジ・サービスのコードを編集します。
- **hzn.json** 構成ファイルのサービス・バージョン変数で、コードの意味体系に沿ったバージョン番号を編集します。
- サービス・コンテナーを再ビルドします。
- 新しいエッジ・サービス・バージョンに署名して Horizon Exchange に公開します。

## パターンまたはデプロイメント・ポリシーのロールバック設定の更新
{: #updating_rollback_settings}

新しいエッジ・サービスでは、サービス定義の `version` フィールドにバージョン番号を指定します。

どのサービスがどのエッジ・ノードにデプロイされるかは、パターンまたはデプロイメント・ポリシーが決定します。 エッジ・サービスのロールバック機能を使用するには、パターンまたはデプロイメント・ポリシーの構成ファイルで、**serviceVersions** セクションに新しいサービス・バージョン番号の参照を追加する必要があります。

エッジ・サービスがパターンまたはポリシーの結果としてエッジ・ノードにデプロイされる際、エージェントは、優先順位の値が最も高いサービス・バージョンをデプロイします。

以下に例を示します。

```json
 "serviceVersions": 
[
 {
   "version": "2.3.1",
   "priority": {
    "priority_value": 2,
    "retries": 1,
    "retry_durations": 1800
   }
 },
      {
        "version": "1.0.0",
   "priority": {
    "priority_value": 6,
    "retries": 1,
    "retry_durations": 2400
   }
  },
      {
        "version": "2.3.0",
   "priority": {
    "priority_value": 4,
    "retries": 1,
    "retry_durations": 3600
   }
  }
]
```
{: codeblock}

priority セクションには、さらに変数が用意されています。`priority_value` プロパティーは、先に試行するサービス・バージョンの順序を設定します。実務的には、番号が小さいほど、優先順位が高くなります。 `retries` 変数の値は、優先順位が次に高いバージョンにロールバックすることになる前に、`retry_durations` で指定された時間フレーム内に Horizon がこのサービス・バージョンの開始を試行する回数を定義します。 `retry_durations` 変数は、具体的な時間間隔を秒単位で定義します。 例えば、1 カ月にわたる中でサービスが 3 回失敗した場合、そのサービスを以前のバージョンにロールバックすることが必要とは言えない可能性がありますが、5 分間に 3 回失敗した場合には、新しいサービス・バージョンでの問題を示唆している可能性があります。

次に、Horizon Exchange でデプロイメント・パターンをリパブリッシュするか、**serviceVersion** セクションの変更でデプロイメント・ポリシーを更新します。

デプロイメント・ポリシーまたはパターンの設定更新の互換性は、CLI `deploycheck` コマンドでも検証できます。 詳細を表示するには、以下を実行してください。

```bash
hzn deploycheck -h
```
{: codeblock}

{{site.data.keyword.ieam}} agbot は、デプロイメント・パターンまたはデプロイメント・ポリシーの変更を素早く検出します。 その後、agbot は、そのデプロイメント・パターンを実行するようにエッジ・ノードが登録されている各エージェント、または更新されたデプロイメント・ポリシーとエッジ・ノードが互換である各エージェントに到達します。 agbot とエージェントは、新しいコンテナーをダウンロードし、古いコンテナーを停止および削除し、新しいコンテナーを開始するように調整します。

その結果、更新されたデプロイメント・パターンを実行するように登録されたエッジ・ノード、またはデプロイメント・ポリシーと互換であるエッジ・ノードが、置かれている地理的場所に関係なく、新しいエッジ・サービス・バージョンを素早く実行します。
 

## 新規サービス・バージョンのロールアウト進行状況の表示
{: #viewing_rollback_progress}

`agreement_finalized_time` フィールドおよび `agreement_execution_start_time` フィールドが埋まるまで、デバイスの合意を繰り返し照会します。 

```bash
hzn agreement list
```
{: codeblock}

リストされた合意には、サービスに関連付けられたバージョンが示され、変数 (例えば、"agreement_creation_time": "" など) に日付値が表示されます。

さらに、version フィールドには、以下のように、優先順位値が最も高い、新しい (かつ、操作可能な) サービス・バージョンが入ります。

```json
[
  {
    …
    "agreement_creation_time": "2020-04-01 11:55:08 -0600 MDT",
    "agreement_accepted_time": "2020-04-01 11:55:17 -0600 MDT",
    "agreement_finalized_time": "2020-04-01 11:55:18 -0600 MDT",
    "agreement_execution_start_time": "2020-04-01 11:55:20 -0600 MDT",
    "agreement_data_received_time": "",
    "agreement_protocol": "Basic",
    "workload_to_run": {
      "url": "ibm.helloworld",
      "org": "ibm",
      "version": "2.3.1",
      "arch": "amd64"
    }
  }
]
```
{: codeblock}

追加の詳細について、以下の CLI コマンドで現行ノードのイベント・ログを調べることができます。

```bash
hzn eventlog list
```
{: codeblock}

最後に、[管理コンソール](../console/accessing_ui.md)を使用してデプロイメント・バージョンのロールバックの設定を変更することも可能です。 これは、デプロイメント・ポリシーを新規作成するとき、またはロールバック設定を含む既存のポリシー詳細を表示して編集することで行えます。UI のロールバック・セクションにある「時間フレーム」の項目が、CLI の "retry_durations" に相当します。
